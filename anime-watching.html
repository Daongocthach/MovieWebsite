<!DOCTYPE html>
<html lang="zxx">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Anime Template">
    <meta name="keywords" content="Anime, unica, creative, html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Stone Movies | Watching</title>
    <link rel="icon" type="image/svg+xml" href="./img/icon.png" />
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Css Styles -->
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="css/elegant-icons.css" type="text/css">
    <link rel="stylesheet" href="css/plyr.css" type="text/css">
    <link rel="stylesheet" href="css/nice-select.css" type="text/css">
    <link rel="stylesheet" href="css/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="css/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="css/style.css" type="text/css">
</head>

<body>
    <!-- Page Preloder -->
    <div id="preloder">
        <div class="loader"></div>
    </div>

    <!-- Header Section Begin -->
    <header class="header">
        <div class="container">
            <div class="row">
                <div class="col-lg-2">
                    <div class="header__logo">
                        <a href="./index.html">
                            <img src="img/logo.png" alt="">
                        </a>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="header__nav">
                        <nav class="header__menu mobile-menu">
                            <ul>
                                <li><a href="./index.html">Trang chủ</a></li>
                                <li class="active"><a href="#">Thể loại <span class="arrow_carrot-down"></span></a>
                                    <ul class="dropdown">
                                        <li class="dropdown-column">
                                            <a href="./categories.html?slug=hanh-dong">Hành Động</a>
                                            <a href="./categories.html?slug=phieu-luu">Phiêu Lưu</a>
                                            <a href="./categories.html?slug=hoat-hinh">Hoạt Hình</a>
                                            <a href="./categories.html?slug=hai">Hài</a>
                                            <a href="./categories.html?slug=hinh-su">Hình Sự</a>
                                            <a href="./categories.html?slug=tai-lieu">Tài Liệu</a>
                                        </li>
                                        <li class="dropdown-column">
                                            <a href="./categories.html?slug=chinh-kich">Chính Kịch</a>
                                            <a href="./categories.html?slug=gia-dinh">Gia Đình</a>
                                            <a href="./categories.html?slug=gia-tuong">Giả Tưởng</a>
                                            <a href="./categories.html?slug=lich-su">Lịch Sử</a>
                                            <a href="./categories.html?slug=kinh-di">Kinh Dị</a>
                                            <a href="./categories.html?slug=nhac">Nhạc</a>
                                        </li>
                                        <li class="dropdown-column">
                                            <a href="./categories.html?slug=bi-an">Bí Ẩn</a>
                                            <a href="./categories.html?slug=lang-man">Lãng Mạn</a>
                                            <a href="./categories.html?slug=khoa-hoc-vien-tuong">Khoa Học Viễn Tưởng</a>
                                            <a href="./categories.html?slug=gay-can">Gây Cấn</a>
                                            <a href="./categories.html?slug=chien-tranh">Chiến Tranh</a>
                                            <a href="./categories.html?slug=tam-ly">Tâm Lý</a>
                                        </li>
                                        <li class="dropdown-column">
                                            <a href="./categories.html?slug=tinh-cam">Tình Cảm</a>
                                            <a href="./categories.html?slug=co-trang">Cổ Trang</a>
                                            <a href="./categories.html?slug=mien-tay">Miền Tây</a>

                                        </li>
                                    </ul>
                                </li>
                                <li><a href="./blog.html">Thông tin</a></li>
                                <li><a href="#">Liên hệ</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
                <div class="col-lg-2">
                    <div class="header__right">
                        <a href="#" class="search-switch"><span class="icon_search"></span></a>
                        <a href="./login.html"><span class="icon_profile"></span></a>
                    </div>
                </div>
            </div>
            <div id="mobile-menu-wrap"></div>
        </div>
    </header>
    <!-- Header End -->

    <!-- Breadcrumb Begin -->
    <div class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb__links">
                        <a href="./index.html"><i class="fa fa-home"></i> Trang chủ</a>
                        <a href="#">Thể loại</a>
                        <a href="#">Xem phim</a>
                        <span id="movieName">N/A</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Anime Section Begin -->
    <section class="anime-details spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="anime__video__player" id="noVideo">
                        <video id="video-player" controls width="100%" data-poster="./videos/anime-watch.jpg">
                            <source src="" type="application/x-mpegURL">
                            <track kind="captions" label="English captions" src="#" srclang="en" default />
                            Trình duyệt của bạn không hỗ trợ phát video.
                        </video>
                        <div id="loading"></div>
                    </div>
                    <div class="anime__details__episodes">
                        <div class="section-title">
                            <h5 id="embedLink">Danh sách tập</h5>
                        </div>
                        <div id="episodeList"></div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-8">
                    <div class="anime__details__review">
                        <div class="section-title">
                            <h5>Bình luận</h5>
                        </div>
                        <div class="anime__review__item">
                            <div class="anime__review__item__pic">
                                <img src="img\blog\details\comment-1.png" alt="">
                            </div>
                            <div class="anime__review__item__text">
                                <h6>Chris Curry - <span>1 giờ trước</span></h6>
                                <p>whachikan Just noticed that someone categorized this as belonging to the genre
                                    "demons" LOL</p>
                            </div>
                        </div>
                    </div>
                    <div class="anime__details__form">
                        <div class="section-title">
                            <h5>Bình luận của bạn</h5>
                        </div>
                        <form action="#">
                            <textarea placeholder="Bình luận của bạn"></textarea>
                            <button type="submit"><i class="fa fa-location-arrow"></i> Gửi</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Anime Section End -->

    <!-- Footer Section Begin -->
    <footer class="footer">
        <div class="page-up">
            <a href="#" id="scrollToTopButton"><span class="arrow_carrot-up"></span></a>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-lg-3">
                    <div class="footer__logo">
                        <a href="./index.html"><img src="img/logo.png" alt=""></a>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="footer__nav">
                        <ul>
                            <li class="active"><a href="./index.html">Homepage</a></li>
                            <li><a href="./categories.html">Categories</a></li>
                            <li><a href="./blog.html">Our Blog</a></li>
                            <li><a href="#">Contacts</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3">
                    <p><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                        Copyright &copy;
                        <script>document.write(new Date().getFullYear());</script> Liên hệ: pemeoh1@gmail.com
                        <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                    </p>
                </div>
            </div>
        </div>
        </div>
    </footer>
    <!-- Footer Section End -->

    <!-- Search model Begin -->
    <div class="search-model">
        <div class="h-100 d-flex align-items-center justify-content-center">
            <div class="search-close-switch"><i class="icon_close"></i></div>
            <form class="search-model-form" id="search-form">
                <input type="text" id="search-input" placeholder="Nhập tên phim.....">
                <button type="submit" class="site-btn"><i class="fa fa-search" aria-hidden="true"></i> Tìm</button>
            </form>
        </div>
    </div>
    <!-- Search model end -->

    <!-- Js Plugins -->
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/player.js"></script>
    <script src="js/jquery.nice-select.min.js"></script>
    <script src="js/mixitup.min.js"></script>
    <script src="js/jquery.slicknav.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        function loadVideo(url) {
            const videoPlayer = document.getElementById("video-player");
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoPlayer);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    videoPlayer.play();
                });
            } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                // Trình duyệt hỗ trợ HLS (chủ yếu là Safari)
                videoPlayer.src = url;
                videoPlayer.addEventListener("loadedmetadata", () => {
                    videoPlayer.play();
                });
            } else {
                console.error("Trình duyệt không hỗ trợ phát tệp HLS.");
            }
        }
        async function fetchMovieDetails(slug) {
            // Hiển thị loading
            const loadingDiv = document.getElementById("loading");
            loadingDiv.style.display = "block";
            const noVideo = document.getElementById("noVideo");

            try {
                const response = await fetch(`https://ophim1.com/phim/${slug}`);
                const data = await response.json();

                if (!data.status) {
                    throw new Error("Không lấy được dữ liệu từ API chính.");
                }

                const movie = data.movie;
                const episodes = data.episodes[0]?.server_data;

                if (episodes && episodes.length > 0) {
                    const firstEpisodeUrl = episodes[0]?.link_m3u8;
                    if (firstEpisodeUrl) {
                        loadVideo(firstEpisodeUrl);
                    } else {
                        console.warn("Không có tập phim nào khả dụng.");
                    }

                    // Hiển thị danh sách tập phim
                    const name = document.getElementById("movieName");
                    name.textContent = movie.name;
                    const episodeListDiv = document.getElementById("episodeList");
                    const urlParams = new URLSearchParams(window.location.search);
                    const currentEpisode = urlParams.get("episode");

                    episodes.forEach((episode, index) => {
                        const episodeLink = document.createElement("a");
                        episodeLink.href = `./anime-watching.html?slug=${movie.slug}&episode=${episode.slug}`;
                        episodeLink.textContent = `Tập ${index + 1}`;

                        if (episode.slug === currentEpisode || (index === 0 && !currentEpisode)) {
                            episodeLink.classList.add("highlight");
                        }

                        episodeLink.addEventListener("click", (event) => {
                            event.preventDefault(); // Ngăn chặn reload trang
                            loadVideo(episode.link_m3u8);
                        });

                        episodeListDiv.appendChild(episodeLink);
                    });

                    // Cấu hình lớp CSS để làm sáng episode hiện tại
                    const style = document.createElement("style");
                    style.innerHTML = `
                .highlight {
                    font-weight: bold;
                    font-size: 20px;
                    color: #123;
                    text-decoration: underline;
                }
            `;
                    document.head.appendChild(style);
                } else {
                    console.warn("Không tìm thấy tập phim nào trong API chính.");
                    throw new Error("Không có tập phim nào khả dụng.");
                }
            } catch (error) {
                console.warn("API chính thất bại, thử lấy link nhúng dự phòng.");

                try {
                    const fallbackResponse = await fetch(`https://phim.nguonc.com/api/film/${slug}`);
                    const fallbackData = await fallbackResponse.json();

                    const movie = fallbackData.movie;
                    const episodes = movie.episodes[0]?.items;

                    if (!episodes || episodes.length === 0) {
                        throw new Error("Không tìm thấy tập phim nào trong API dự phòng.");
                    }

                    const name = document.getElementById("movieName");
                    name.textContent = movie.name;

                    const embedLink = document.getElementById("embedLink");
                    embedLink.textContent = "Danh sách tập từ link dự phòng";

                    noVideo.style.display = "none"; // Ẩn video
                    const episodeListDiv = document.getElementById("episodeList");

                    episodes.forEach((episode, index) => {
                        const episodeLink = document.createElement("a");
                        episodeLink.href = episode.embed;
                        episodeLink.target = "_blank"; // Mở link nhúng trong tab mới
                        episodeLink.textContent = `Tập ${index + 1}`;
                        episodeListDiv.appendChild(episodeLink);
                    });
                } catch (fallbackError) {
                    console.error("Không lấy được dữ liệu từ API dự phòng.", fallbackError);
                }
            } finally {
                // Ẩn loading
                loadingDiv.style.display = "none";
            }
        }

        function getSlugFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get("slug");
        }

        document.addEventListener("DOMContentLoaded", function () {
            const slug = getSlugFromUrl();
            if (slug) {
                fetchMovieDetails(slug);
            } else {
                console.warn("Không tìm thấy slug trong URL.");
            }
        });
    </script>
</body>

</html>